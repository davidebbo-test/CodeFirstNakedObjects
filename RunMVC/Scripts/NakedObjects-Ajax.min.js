var nakedObjects=function(){var a={};a.ajaxCount=0;var b,j;a.getDisabledSubmits=function(){return b};a.checkForEnter=function(d){if(d.keyCode===13){if(this.nodeName.toLowerCase()==="button"){this.click();return false}var c=$(this).closest("form"),b=c.find("button.OK:first");if(b.length>0){b.get(0).focus();b.get(0).click();return false}var a=c.find("button:submit[name='']:first");if(a.length>0){a.get(0).focus();a.get(0).click();return false}return true}else return true};a.focusOnFirst=function(){var d=$("button.OK:first"),c=$("button.Save:first");if(d.length>0){var a=d.closest(".ActionDialog");if(a.length>0){a.find("input[type='text'], input[type='checkbox'], select, textarea").first().focus();a.find(".input-validation-error").first().focus()}}else if(c.length>0){var b=c.closest(".ObjectEdit");if(b.length>0){b.find("input[type='text'], input[type='checkbox'], select, textarea").first().focus();b.find(".input-validation-error").first().focus()}}else{$("input[type='text'], input[type='checkbox'], select, textarea").first().focus();$(".input-validation-error").first().focus()}};a.clearHistory=function(){a.ajaxCount++;$.post($(this).attr("action"),$(this).serialize(),function(b){if($(".History button").attr("value").split("=")[1].toLowerCase()==="true"){$(".History div.Object").replaceWith("");$(".History > form").replaceWith($(""))}else{$(".History div.Object:not(:last)").replaceWith("");$(".History div.Object:first").replaceWith($(".History div.Object:first",b));$(".History button").attr("value","clearAll=False")}d(false);a.ajaxCount--});return false};function k(){return $("form button.lastClicked").get(0)}function v(a,b){$("div#main").append("<div id='_errorMessage' title='"+a+"'>"+b+"</div>");$("#_errorMessage").dialog({draggable:true,height:"500",width:"1000",close:function(){$("#_errorMessage").remove()}})}function h(a){$(a).effect("highlight",{},500);b=$(":submit, this");b.attr("disabled","disabled");$("body").css("cursor","progress")}function c(){if(b){b.removeAttr("disabled");$("body").css("cursor","auto");b=null;return true}return false}function n(){j=true;$("a").css("cursor","progress")}function o(){if(j){j=null;$("a").css("cursor","pointer");return true}return false}a.bindAjaxError=function(){$("div#main").ajaxError(function(e,d,b){if(c()||o())a.ajaxCount--;v("Ajax Error","Error in: "+b.url+" \nerror:\n"+d.responseText)})};function f(){$("div.Collection-Table button.Summary").show();$("div.Collection-Table button.List").show();$("div.Collection-Table button.Table").hide();$("div.Collection-List button.Summary").show();$("div.Collection-List button.List").hide();$("div.Collection-List button.Table").show();$("div.Collection-Summary button.Summary").hide();$("div.Collection-Summary button.List").show();$("div.Collection-Summary button.Table").show()}function g(){$("div.Property > div.Object > a").closest("div.Property").find("> div.Object > form button.Minimize").hide();$("div.Property > div.Object > a").closest("div.Property").find("> div.Object > form button.Maximize").show();$("div.Property > div.Object > div.PropertyList").closest("div.Property").find("> div.Object > form button.Maximize").hide();$("div.Property > div.Object > div.PropertyList").closest("div.Property").find("> div.Object > form button.Minimize").show()}function u(b,a,c){b.each(function(e,d){var b=$(d).attr(a);b&&$(d).attr(a,c+b)})}a.redisplayInlineProperty=function(e){a.ajaxCount++;var b=k(e);if(!b||b.name!=="Redisplay"){a.ajaxCount--;return true}h(b);var d=$(this).serializeArray();d[d.length]={name:b.name,value:b.value};$.post($(this).attr("action"),d,function(j){var h=$(b).closest("div.Property"),d=h.find("> div.Object"),i=d.find("> a"),e=$("div.PropertyList",j);e.find("> form").remove();var k=h.attr("id")+"-";u(e.find("*"),"id",k);i.toggle();if($(b).hasClass("Maximize")){d.append(e);d.find("> img").after($("<span>"+i.text()+"</span>"))}else{d.find("> div.PropertyList").remove();d.find("> span").remove()}g();f();c();a.ajaxCount--});return false};function w(c){var a=c.split("-"),b=a.length;return a[b-2]+"-"+a[b-1]}a.redisplayProperty=function(e){a.ajaxCount++;var b=k(e);if(!b||b.name!=="Redisplay"){a.ajaxCount--;return true}h(b);var d=$(this).serializeArray();d[d.length]={name:b.name,value:b.value};$.post($(this).attr("action"),d,function(d){var h=$(b).closest("div.Property"),i=w(h.attr("id")),e=$(d).find("div#"+i);if(e.length>0){h.replaceWith(e);var j=$("input[id$='-displayFormats']:first",d).attr("value");$("form  input[id$='-displayFormats']").attr("value",j)}else $("div#main").replaceWith($("div#main",d));g();f();c();a.ajaxCount--});return false};a.updateTitle=function(b){var c=/<title>\s*?(.*?)\s*?<\/title>/,a=b.match(c),d=a?a[1]:"";document.title=$.trim(d)};function r(b,c){var a=$(b,c);if(a.length>0){$(b).replaceWith(a);return true}return false}function i(a){return r("div#main",a)?void 0:r("body",a)?void 0:void 0}function p(){if($("div.ObjectEdit").hasClass("Transient")){var a=$("div.ObjectEdit form.Edit").attr("action");if(a)return e(a)}return false}a.getLinkFromHistory=function(){var c=$("div#main > div.ActionDialog").length>0,b=p(),a;if(c)a=$("div.ActionDialog > form").attr("action");else if(b)a="/Transient?id="+escape(b);else{a=$(".History div.Object:last a").attr("href");var d=$("div#main > div.ObjectEdit").length>0;if(d)a=a.replace("/Details?","/EditObject?")}return a};function s(){var b=a.getLinkFromHistory();$.address.value(b)}function t(){var a=p();a&&$.jStorage.set("transient:"+a,$("div#main").html())}a.cacheFormValues=function(b){$("form div.Parameter:has(div.Object), form div.Property:has(div.Object)").each(function(b,a){$.jStorage.set(a.id,$(a).html())});for(var c={},a=0;a<b.length;a++)if(b[a].value.toLowerCase()!=="false"||!c[b[a].name])c[b[a].name]=b[a].value;for(nv in c)$.jStorage.set(nv,c[nv])};function l(){$("form.Edit, form.Dialog").each(function(){var b=$(this).serializeArray();a.cacheFormValues(b)})}function m(){$("form div.Parameter:has(div.Object), form div.Property:has(div.Object)").each(function(c,b){var a=$.jStorage.get(b.id,null);a&&$(b).html(a)});$("form input, form select, form textarea").each(function(c,a){var b=$.jStorage.get($(a).attr("name"),null);if(b)if($(a).attr("type")==="checkbox")if(b.toLowerCase()==="true")$(a).attr("checked","checked");else $(a).removeAttr("checked");else($(a).attr("type")!=="hidden"||!!$(a).id)&&$(a).val(b)})}a.updateChoices=function(){a.ajaxCount++;var b=$(this).closest("div[data-choices]"),l=b.find("select");if(b.length==0||l.length==0){a.ajaxCount--;return true}var m=$(this).closest("form"),n=b.attr("data-choices"),j=b.attr("data-choices-parameters"),c=j.split(",");if(!j||$.inArray($(this).attr("id"),c)===-1&&$.inArray($(this).attr("id"),"-encryptedField-"+c)===-1){a.ajaxCount--;return true}var d={},g=m.serializeArray();function k(c){for(var a=0;a<g.length;a++){var b=g[a];if(b.name===c)return b.value}return""}for(var f=0;f<c.length;f++){var e=c[f],h="-encryptedField-"+e,i=k(h);if(i)d[h]=i;else d[e]=k(e)}$.ajaxSetup({cache:false});$.getJSON(n,d,function(b){l.each(function(){var d=$(this).attr("id");if(typeof b[d]!=="undefined"){for(var h=b[d][0],c=b[d][1],f="",e=0;e<c.length;e++)f+=c[e];var g=$(this).find("option"),i=g.text();if(i!==f){g.replaceWith("");$(this).append("<option/>");for(var a=0;a<h.length;a++)$(this).append($("<option value='"+h[a]+"'>"+c[a]+"</option>"))}}});a.ajaxCount--});return true};a.updatePageFromAction=function(g){a.ajaxCount++;var b=k(g);if(!b||b.name==="Redisplay"){a.ajaxCount--;return true}if($(b).closest("form").find(":input[type=file]").length>0){a.ajaxCount--;return true}l();h(b);var e=$(this).serializeArray();e[e.length]={name:b.name,value:b.value};var f=$(this).attr("class")==="Dialog";$.post($(this).attr("action"),e,function(e){if(b.name==="Finder"||b.name==="Selector"||b.name==="ActionAsFinder"||b.name==="InvokeActionAsFinder"||b.name==="InvokeActionAsSave"){var k=f?"Parameter":"Property",g="div."+k+":has(button[value='"+$(b).attr("value")+"'])",j=$(g).attr("id"),h=$("div#"+j,e);if(h.length>0){$(g).replaceWith(h);$("#"+j).find(":input").each(a.updateChoices)}else i(e)}else{a.updateTitle(e);i(e)}d(true);t();c();a.ajaxCount--});return false};function e(a){var b=a.substring(a.indexOf("id=")+3);return unescape(b)}a.isValid=function(f,b){a.ajaxCount++;var c=b.attr("data-validate");if(!c){a.ajaxCount--;return}var d=f.find("a").attr("href"),h=e(d),g={value:h};$.ajaxSetup({cache:false});$.getJSON(c,g,function(d){if(d===true){b.addClass("validdrop");var c=$.ui.ddmanager.current;$.ui.ddmanager.prepareOffsets(c);$.each($.ui.ddmanager.droppables[c.options.scope]||[],function(){if($.ui.intersect(c,this,c.options.tolerance||"intersect"))this.element.hasClass("validdrop")&&this.element.addClass("withindrop")})}a.ajaxCount--})};a.updateOnSelect=function(){var b=$(this).closest("div.Property > div.Object");if(b.length==0)b=$(this).closest("div.Parameter > div.Object");var d=$(this).closest("div.Object"),i=b.find("> a"),f=d.find("a"),j=f.attr("href"),k=e(j);if(i.length>0)i.replaceWith(f);else b.prepend(f);b.find("> a").text(d.contents().filter(function(){return this.nodeType==3}).text());var h=b.find("> img"),g=d.find("img");if(h.length>0)h.replaceWith(g);else b.prepend(g);b.find("input").attr("value",k);var c=b.find("input").attr("name");if(c.indexOf("-encryptedField-")===0){c=c.substring(16);b.find("input").attr("name",c)}$(this).closest("div.Collection-List").remove();b.find("input").each(a.updateChoices)};function d(b){$("div.History div.Object").draggable({helper:"clone",start:function(){var b=$(this);$(".ui-droppable").each(function(){a.isValid(b,$(this))})}});$("form div.Object").droppable({drop:function(j,b){var h=b.helper.find("a").attr("href"),i=e(h),g=$(this).find("a"),d=b.helper.find("a");if(g.length>0)g.replaceWith(d);else $(this).prepend(d);var f=$(this).find("img"),c=b.helper.find("img");if(f.length>0)f.replaceWith(c);else $(this).prepend(c);$(this).find("input").attr("value",i);var a=$(this).find("input").attr("name");if(a.indexOf("-encryptedField-")===0){a=a.substring(16);$(this).find("input").attr("name",a)}},deactivate:function(){$(".validdrop").removeClass("validdrop");$(".withindrop").removeClass("withindrop")},accept:function(){return $(this).hasClass("validdrop")},hoverClass:"withindrop"});a.focusOnFirst();b&&s();$.validator.unobtrusive.parse($("div#main"));$("input.datetime").removeClass("hasDatepicker");$("input.datetime").datepicker();$.validator.setDefaults({onkeyup:false});g();f();a.bindAjaxError()}function q(f,e){a.ajaxCount++;$.ajaxSetup({cache:false});var b=f.attr("href");l();if(b.substring(0,14)==="/Transient?id="){var g=unescape(b.substring(14)),c=$.jStorage.get("transient:"+g);if(c){$("div#main").html(c);m();d(e);a.ajaxCount--;return false}}$.get(b,function(b){a.updateTitle(b);i(b);m();d(e);o();a.ajaxCount--});return false}a.updatePageFromLink=function(){n();return q($(this),true)};a.syncPageToAddress=function(){n();return q($(this),false)};a.markedClicked=function(){$("form button.lastClicked").removeClass("lastClicked");$(this).addClass("lastClicked");return true};a.allowSubmit=function(){$(this).closest("form").validate().cancelSubmit=true;return true};return a}();$.address.externalChange(function(a){if(a.value==="/")return;$("<a href='"+a.value+"'></a>").click(nakedObjects.syncPageToAddress).click()});$(window).unload(function(){$("form.Edit, form.Dialog").each(function(){var a=$(this).serializeArray();nakedObjects.cacheFormValues(a)})});$(window).load(function(){var c=location.href;if(c.indexOf("#")===-1){var a=$("div#header > a").attr("href");if(location.pathname!==a){var b=nakedObjects.getLinkFromHistory();if(b)location.href=location.protocol+"//"+location.host+a+"/#"+b}}return true});window.onerror=function(b,c,a){alert("Error message: "+b+"\nURL: "+c+"\nLine Number: "+a);return true};nakedObjects.bindAjaxError();$(function(){$("form button").live("click",nakedObjects.markedClicked)});$(function(){$("form button[name=Finder], form button[name=Redisplay], form button[name=Selector], form button[name=ActionAsFinder], form button[name=InvokeActionAsFinder]").live("click",nakedObjects.allowSubmit)});$(function(){$("form button[title=Select]").live("click",nakedObjects.updateOnSelect)});$(function(){$(":input").live("change",nakedObjects.updateChoices)});$(function(){$(".History form").live("submit",nakedObjects.clearHistory)});$(function(){$("form:has(button.Summary)").live("submit",nakedObjects.redisplayProperty)});$(function(){$("form:has(button.Maximize)").live("submit",nakedObjects.redisplayInlineProperty)});$(function(){$("form.Edit").live("submit",nakedObjects.redisplayProperty)});$(function(){$(".Menu form.Action, .PropertyList form.Action, .ObjectEdit form.Action, .StandaloneTable form.Action, form.Edit, form.Dialog, .ActionDialog form.Action").live("submit",nakedObjects.updatePageFromAction)});$(function(){$("div.Object a").live("click",nakedObjects.updatePageFromLink)});$(function(){$("#checkboxAll").live("change",function(){$("input[type='checkbox']").attr("checked",$("#checkboxAll").is(":checked"))})});$(function(){$("form :input:not(textarea)").live("keydown",nakedObjects.checkForEnter)});